<?php
require_once __DIR__ . '/../vendor/autoload.php';

// Create Laravel app instance
$app = require_once __DIR__ . '/../bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();

use App\Models\Warehouse;
use App\Models\Product;

echo "<!DOCTYPE html><html><head><title>ุงุฎุชุจุงุฑ ุฅุตูุงุญ ุฅุถุงูุฉ ุงูููุชุฌ</title>";
echo "<style>body{font-family:Arial;direction:rtl;} .success{color:green;background:#d4edda;padding:15px;margin:10px 0;border-radius:5px;} .error{color:red;background:#f8d7da;padding:15px;margin:10px 0;border-radius:5px;} .info{background:#d1ecf1;padding:15px;margin:10px 0;border-radius:5px;} input,button{margin:5px;padding:10px;}</style>";
echo "</head><body>";
echo "<h2>๐ง ุงุฎุชุจุงุฑ ุฅุตูุงุญ ุฅุถุงูุฉ ุงูููุชุฌ</h2>";

if ($_POST && isset($_POST['test_create'])) {
    echo "<div class='info'><h3>๐งช ุงุฎุชุจุงุฑ ุฅูุดุงุก ููุชุฌ ูุจุงุดุฑ:</h3></div>";
    
    try {
        $productData = [
            'name_ar' => $_POST['name'],
            'carton_size' => (int)$_POST['units_per_carton'],
            'active' => true
        ];
        
        echo "<p><strong>ุงูุจูุงูุงุช:</strong> " . json_encode($productData, JSON_UNESCAPED_UNICODE) . "</p>";
        
        $product = Product::create($productData);
        
        echo "<div class='success'>";
        echo "<h4>โ ูุฌุญ ุฅูุดุงุก ุงูููุชุฌ!</h4>";
        echo "<ul>";
        echo "<li><strong>ID:</strong> {$product->id}</li>";
        echo "<li><strong>ุงูุงุณู (name_ar):</strong> {$product->name_ar}</li>";
        echo "<li><strong>ุงูุงุณู (accessor):</strong> {$product->name}</li>";
        echo "<li><strong>ุญุฌู ุงููุฑุชูู:</strong> {$product->carton_size}</li>";
        echo "<li><strong>ูุญุฏุงุช/ูุฑุชูู (accessor):</strong> {$product->units_per_carton}</li>";
        echo "</ul>";
        echo "</div>";
        
    } catch (Exception $e) {
        echo "<div class='error'>";
        echo "<h4>โ ูุดู ุฅูุดุงุก ุงูููุชุฌ:</h4>";
        echo "<p><strong>ุงูุฎุทุฃ:</strong> " . $e->getMessage() . "</p>";
        echo "</div>";
    }
}

$warehouses = Warehouse::all();

echo "<div class='info'>";
echo "<h3>๐ ุญุงูุฉ ุงููุธุงู:</h3>";
echo "<ul>";
echo "<li><strong>ุนุฏุฏ ุงููุฎุงุฒู:</strong> " . $warehouses->count() . "</li>";
echo "<li><strong>ุนุฏุฏ ุงูููุชุฌุงุช:</strong> " . Product::count() . "</li>";
echo "</ul>";
echo "</div>";

// Test form for direct product creation
echo "<h3>๐งช ุงุฎุชุจุงุฑ ุฅูุดุงุก ููุชุฌ ูุจุงุดุฑ:</h3>";
echo "<form method='POST'>";
echo "<input type='hidden' name='test_create' value='1'>";
echo "<p>ุงุณู ุงูููุชุฌ: <input type='text' name='name' value='ููุชุฌ ุงุฎุชุจุงุฑ " . time() . "' required></p>";
echo "<p>ูุญุฏุงุช/ูุฑุชููุฉ: <input type='number' name='units_per_carton' value='24' required></p>";
echo "<p><button type='submit' style='background:green;color:white;padding:15px;'>ุฅูุดุงุก ููุชุฌ ููุงุฎุชุจุงุฑ</button></p>";
echo "</form>";

// Test form for warehouse product creation
if ($warehouses->count() > 0) {
    $warehouse = $warehouses->first();
    
    echo "<h3>๐ช ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ููุชุฌ ูููุฎุฒู:</h3>";
    echo "<p><strong>ุงููุฎุฒู:</strong> {$warehouse->name} (ูููุฉ ุงููุฑูุฑ: {$warehouse->password})</p>";
    
    // Check if logged in
    $isLoggedIn = session("warehouse_{$warehouse->id}_auth");
    if (!$isLoggedIn) {
        echo "<div class='error'>";
        echo "<p>โ ุบูุฑ ูุณุฌู ุฏุฎูู ูู ูุฐุง ุงููุฎุฒู</p>";
        echo "<form method='POST' action='/warehouses/{$warehouse->id}/login' style='display:inline;'>";
        echo "<input type='hidden' name='_token' value='" . csrf_token() . "'>";
        echo "<input type='hidden' name='password' value='{$warehouse->password}'>";
        echo "<button type='submit' style='background:blue;color:white;padding:10px;'>ุชุณุฌูู ุฏุฎูู {$warehouse->name}</button>";
        echo "</form>";
        echo "</div>";
    } else {
        echo "<div class='success'>";
        echo "<p>โ ูุณุฌู ุฏุฎูู ูู ุงููุฎุฒู</p>";
        echo "<form method='POST' action='/warehouses/{$warehouse->id}/products'>";
        echo "<input type='hidden' name='_token' value='" . csrf_token() . "'>";
        echo "<p>ุงุณู ุงูููุชุฌ: <input type='text' name='name' value='ููุชุฌ ูุฎุฒู " . time() . "' required></p>";
        echo "<p>ูุญุฏุงุช/ูุฑุชููุฉ: <input type='number' name='units_per_carton' value='24' required></p>";
        echo "<p>ุงูุญุฏ ุงูุฃุฏูู: <input type='number' name='min_threshold' value='10'></p>";
        echo "<p>ุนุฏุฏ ุงููุฑุงุชูู: <input type='number' name='cartons' value='2' required></p>";
        echo "<p><button type='submit' style='background:green;color:white;padding:15px;'>ุฅุถุงูุฉ ูููุฎุฒู (ุงูุทุฑููุฉ ุงูุฃุตููุฉ)</button></p>";
        echo "</form>";
        echo "</div>";
    }
}

// Show existing products
echo "<h3>๐ฆ ุงูููุชุฌุงุช ุงูููุฌูุฏุฉ:</h3>";
$products = Product::orderBy('id', 'desc')->take(10)->get();
if ($products->count() > 0) {
    echo "<table border='1' style='border-collapse:collapse;width:100%;'>";
    echo "<tr style='background:#f8f9fa;'><th>ID</th><th>ุงูุงุณู</th><th>ุญุฌู ุงููุฑุชูู</th><th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th></tr>";
    foreach ($products as $product) {
        echo "<tr>";
        echo "<td>{$product->id}</td>";
        echo "<td>{$product->name_ar}</td>";
        echo "<td>{$product->carton_size}</td>";
        echo "<td>{$product->created_at->format('Y-m-d H:i')}</td>";
        echo "</tr>";
    }
    echo "</table>";
} else {
    echo "<p>ูุง ุชูุฌุฏ ููุชุฌุงุช</p>";
}

echo "<p><a href='/debug_warehouse_auth.php'>ุชุดุฎูุต ุงููุฎุงุฒู</a> | <a href='/view_logs.php'>ุนุฑุถ ุงูุณุฌูุงุช</a> | <a href='/warehouses'>ุงูุฐูุงุจ ูููุฎุงุฒู</a></p>";
echo "</body></html>";
?>
