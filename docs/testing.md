# قالب تحويل ملاحظات التيستنج إلى تاسكات + برومبتات للـ AI

> **طريقة الاستخدام:** الصق ملاحظات التيستنج الخام في القسم (1). املأ أي سياق ضروري في (2)–(4). سأحوّلها مباشرة إلى تفاصيل وقوائم تاسكات وبرومبتات جاهزة للإرسال للـ AI.

---

## (1) ملاحظات التيستنج الخام

**مصدر الملاحظات (ملخّص المستخدم):**
- المنتجات: Unauthorized عند الإضافة/التعديل، تعطل Export/Import، حذف لا يعمل.
- المبيعات/الفواتير: حقل الفرع يقبل أرقام بدل نص، خيارات دفع ناقصة (Vodafone Cash, InstaPay, Bank Account)، الخصم لا ينعكس على الإجمالي (فيديو قادم)، Unauthorized عند إضافة منتج، خطأ شاشة عند الضغط على "تصفيه"، مشاكل حفظ.
- المشتريات: تكرار مشاكل المبيعات.
- العملاء: العمل العام سليم، لكن تصدير كشف حساب PDF/Excel يفتح شاشة Web غير مناسبة؛ شبهة خطأ في حساب/دمج الرصيد.
- المورّدون: بحاجة Email Validation.
- الفواتير: خصم/ضريبة لا تُحسب بدقة، حفظ غير موثوق.
- المرتجعات: فشل إنشاء إذن مرتجع بسبب Sequence 2025 غير مُهيّأ (شغّل Seeder).
- المدفوعات: خطأ "The cheque number field must be a string." + 3 أخطاء؛ اختيار العميل يعمل هنا لكنه لا يعمل بوحدات أخرى.
- الشيكات: زر إضافة شيك جديد غير موجود.
- التقارير: نقص بيانات (لا منتجات)، PDF يُصدّر لكنه غير قابل للفتح، Excel يعمل.
- المخازن: جميع الأزرار لا تعمل (الوحدة غير قابلة للاستخدام).
- الجرد: الوحدة معطلة بالكامل.

---

## (2) السياق السريع عن المشروع / المنتج
- نوع النظام: نظام إدارة مخزون/مبيعات (ويب) — **TBD** إطار العمل (مثلاً Laravel + Vue/React؟)
- البيئة/الإصدار المتأثر: بيئة Staging/Prod لعام 2025 — **TBD**
- المستخدم/الشخصية المستهدفة: مسؤول مبيعات/مخزون، محاسب، مدير متجر.
- روابط أو سكرينشوتس: فيديو لخطأ الخصم **قادم**؛ يُفضّل لقطات شاشة لأخطاء Unauthorized وSettlement.

---

## (3) الهدف من المعالجة الآن
- **P0:** إزالة حواجز الاستخدام الحرجة (Unauthorized، تعطل المخازن والجرد، تسلسل المرتجعات 2025) لتمكين العمليات اليومية.
- **P1:** دقة الحسابات (خصم/ضريبة/إجمالي)، استقرار حفظ الفواتير والمدفوعات، إصلاح أخطاء التصفية.
- **P2:** جودة الحياة (Export/Import، PDF Compatibility، Email Validation، إضافة وسائل الدفع، زر الشيكات).

---

## (4) قيود غير وظيفية (NFRs)
- الأداء: إضافة/تعديل/حفظ فاتورة < 2 ثوانٍ متوسطًا على 4G وحواسيب متوسطة.
- الأمان: RBAC دقيق؛ منع تجاوز الصلاحيات؛ سجلات監audit.
- التوافق: Chrome/Edge/Firefox آخر نسخ؛ شاشات 1366px+؛ موبايل أساسي **TBD**.
- اللغات: دعم العربية (RTL) والإنجليزية **TBD**.
- سهولة الوصول: مفاتيح تنقّل ولوحة مفاتيح؛ تباين مناسب.

---

## (5) افتراضات/نواقص معلومات
- إطار العمل Backend يبدو Laravel مع Policies/Middleware للـ Authorization — **تأكيد مطلوب**.
- نماذج PDF تُولَّد عبر Dompdf/Snappy أو خدمة خارجية — **تأكيد مطلوب**.
- خزائن Sequence سنوية لكل نوع سند (returns_vouchers وغيرها) — يلزم Seed/Config.
- اختلاف سلوك اختيار العميل بين الوحدات يشير إلى مكوّن UI/Endpoint مختلف — يلزم تتبّع.

---

## (6) قائمة القضايا بصيغة Given/When/Then (تفصيل سلوك متوقع)

### المنتجات (Products)
**Issue ID:** PROD-001  
**العنوان:** Unauthorized عند إضافة/تعديل منتج  
**الوصف:** يظهر "This action is unauthorized" رغم امتلاك المستخدم لصلاحياته المعلنة.  
**STR:** 1) تسجيل دخول كمستخدم مبيعات 2) فتح المنتجات 3) إضافة/تعديل 4) حفظ.  
**Actual:** رسالة Unauthorized.  
**Expected:** السماح بالعملية عند توافر Role/Permission المناسب، وإلا رسالة مفسِّرة.  
**الأولوية:** P0 | **Severity:** High | **البيئة:** 2025  
**معايير القبول:**  
- Given مستخدم له صلاحية `product.create` أو `product.update`, When يحفظ منتج, Then تُقبل العملية ويُعاد 200/201 مع البيانات.  
- When لا يملك الصلاحية, Then تظهر رسالة مفصّلة (403) مع كود خطأ قياسي.  
**اختبارات:** TC-PROD-001 happy path, TC-PROD-002 deny w/o perm, TC-PROD-003 audit log.

**Issue ID:** PROD-002  
**العنوان:** تعطل Export/Import للمنتجات  
**معايير القبول:** استيراد/تصدير CSV/Excel يعمل، يتحقق من الرؤوس، يُظهر تقرير أخطاء صفّي.

**Issue ID:** PROD-003  
**العنوان:** زر حذف المنتج لا يعمل  
**معايير القبول:** حذف ناعم Soft-delete مع حماية علاقات (FK) ورسالة نجاح.

---

### المبيعات/الفواتير (Sales/Invoices)
**Issue ID:** SALE-001 — حقل الفرع يقبل أرقام بدل نص  
**Expected:** حقل Branch يقبل اسم الفرع (string) مع قائمة اقتراحات.

**Issue ID:** SALE-002 — خيارات دفع ناقصة  
**Expected:** إضافة Vodafone Cash, InstaPay, Bank Account مع التحقق والمعالجة المحاسبية.

**Issue ID:** SALE-003 — الخصم لا ينعكس على الإجمالي  
**Expected:** عند إدخال خصم (قيمة/نسبة)، يُعاد حساب Subtotal, Tax, Grand Total بدقة، ويغطّي خصم السطر والخصم الكلّي.

**Issue ID:** SALE-004 — Unauthorized عند إضافة منتج للفاتورة  
**Expected:** احترام صلاحيات الإضافة للسطور.

**Issue ID:** SALE-005 — خطأ شاشة عند زر "تصفيه" (Settlement)  
**Expected:** تنفيذ العملية أو رسالة تحقّق واضحة مع fallback.

**Issue ID:** SALE-006 — عدم موثوقية الحفظ  
**Expected:** حفظ ذري Transactional مع Rollback عند الفشل ورسالة تأكيد.

---

### المشتريات (Purchases)
**Issue ID:** PUR-001 — تكرار مشاكل SALE-001..006 في وحدة المشتريات بنفس معايير القبول.

---

### العملاء (Customers)
**Issue ID:** CUST-001 — تصدير كشف الحساب يفتح شاشة Web غير مناسبة  
**Expected:** تنزيل PDF/Excel مباشرةً؛ العرض داخل عارض مدمج اختياري.  
**Issue ID:** CUST-002 — شبهة خطأ في رصيد العميل  
**Expected:** الرصيد = مجموع (فواتير مبيعات – دفعات – مرتجعات + ضرائب/خصومات) مع تواريخ صحيحة.

---

### الموردون (Suppliers)
**Issue ID:** SUP-001 — تفعيل Email Validation  
**Expected:** Regex/Validator قياسي + رسائل أخطاء مترجمة.

---

### الفواتير العامة (Invoices Core)
**Issue ID:** INV-001 — حساب الخصم/الضريبة غير دقيق  
**Expected:** ترتيب الحسابات واضح (Line → Subtotal → Discount → Tax → Grand Total) مع تقريب بنكي.  
**Issue ID:** INV-002 — الحفظ غير موثوق  
**Expected:** معاملات ذرّية + إعادة محاولات محدودة + مراقبة أخطاء.

---

### المرتجعات (Returns)
**Issue ID:** RET-001 — Sequence 2025 غير مهيّأ  
**STR:** إنشاء إذن مرتجع → يفشل برسالة sequence.  
**Expected:** تهيئة sequence حسب السنة تلقائيًا أو عبر Seeder مع رسالة إرشادية.

---

### المدفوعات (Payments)
**Issue ID:** PAY-001 — خطأ نوع حقل رقم الشيك  
**Expected:** `cheque_number` نصي، مع تطبيع الإدخال.  
**Issue ID:** PAY-002 — اختيار العميل غير متّسق بين الوحدات  
**Expected:** مكوّن اختيار موحّد يعمل في كل الصفحات.

---

### الشيكات (Cheques)
**Issue ID:** CHQ-001 — زر إضافة شيك مفقود  
**Expected:** زر + صفحة إنشاء مع تحقّقات.

---

### التقارير (Reports)
**Issue ID:** RPT-001 — PDF غير قابل للفتح  
**Expected:** PDF صالح قياسي؛ فحص عبر validators.  
**Issue ID:** RPT-002 — نقص بيانات الاختبار  
**Expected:** Seeder بيانات عيّنية للتقارير.

---

### المخازن (Warehouses)
**Issue ID:** WH-001 — جميع الأزرار لا تعمل  
**Expected:** تفعيل كل الإجراءات الأساسية (إضافة مخزن/نقل/تسوية) مع صلاحيات.

---

### الجرد (Inventory Counting)
**Issue ID:** IC-001 — الوحدة معطلة بالكامل  
**Expected:** تدفّق إنشاء جرد، إضافة بنود، تسوية، تصدير.

---

## (7) تفكيك إلى تاسكات تنفيذية

| Task ID | العنوان | الوصف المختصر | المخرج/النتيجة | المالك | التبعيات | التقدير |
|---|---|---|---|---|---|---|
| T-001 | إصلاح Authorization للمنتجات | مراجعة Policies/Middleware وصلاحيات RBAC للـ create/update/delete | PR يمرّ بالاختبارات + توثيق الصلاحيات | Backend | — | 6h |
| T-002 | تمكين حذف المنتجات بأمان | تفعيل soft-delete + حماية FK ورسائل واضحة | PR + Migration/Seeder عند الحاجة | Backend | T-001 | 4h |
| T-003 | إصلاح Export/Import | تحديث معالجات CSV/Excel + تقارير أخطاء صفية | PR + عينات ملفات + اختبارات | Fullstack | — | 8h |
| T-004 | تصحيح حقل Branch | تحويل الحقل إلى نص + أوتوكمبليت بالأفرع | PR Front + Schema Val. | Frontend | — | 4h |
| T-005 | إضافة وسائل دفع جديدة | توسيع enum/payment methods + UI + قيود محاسبية | PR + ترحيلات + اختبارات | Fullstack | — | 8h |
| T-006 | منطق الخصم والإجمالي | إصلاح الحساب (سطر/كلّي) وترتيب الضريبة | PR + Unit/UITests + Docs | Backend | — | 10h |
| T-007 | استقرار حفظ الفواتير | جعل الحفظ Transactional + معالجة أخطاء | PR + اختبارات تكامل | Backend | T-006 | 6h |
| T-008 | إصلاح زر Settlement | تتبّع الاستثناء وعلاج UI/Backend | PR + سجل أخطاء | Fullstack | T-007 | 5h |
| T-009 | تعميم مكوّن اختيار العميل | بناء مكوّن موحّد + استعماله بكل الوحدات | PR Front + Storybook | Frontend | — | 6h |
| T-010 | تفعيل PDF صالح | تبديل/تهيئة مكتبة PDF + فحص صلاحية الملفات | PR + Validator Script | Backend | — | 6h |
| T-011 | Seeder بيانات التقارير | إنشاء بيانات عيّنية شاملة | Seeder + وثائق | Backend | T-001,T-006 | 3h |
| T-012 | تهيئة Sequence 2025 للمرتجعات | Seeder/Job تلقائي لتكوين التسلسل السنوي | Seeder + وثائق تشغيل | Backend | — | 2h |
| T-013 | إصلاح cheque_number | تحويل النوع لنصي + Val + Migration آمنة | PR + Migrations | Backend | — | 3h |
| T-014 | وحدة الشيكات: زر الإنشاء | إضافة زر وتدفّق Create/Edit | PR Front + Routes | Frontend | — | 3h |
| T-015 | Email Validation للمورّدين | Validator ورسائل مترجمة | PR | Fullstack | — | 2h |
| T-016 | تفعيل المخازن | إصلاح events/actions المعطلة + صلاحيات | PR + Checklists | Fullstack | T-001 | 10h |
| T-017 | تفعيل الجرد | بناء/إصلاح تدفّق الجرد كاملًا | PR + سيناريوهات اختبار | Fullstack | T-016 | 12h |
| T-018 | مراقبة وأثر ما بعد الإطلاق | عدّادات Error/Latency + لوغز監audit | Dashboard + Runbook | DevOps | T-007,T-010 | 6h |

---

## (8) برومبتات جاهزة للـ AI (لكل تاسك)

**Prompt لـ T-001 (Authorization/Policies):**
- **الدور:** أنت مطوّر Laravel خبير في Gate/Policies وRBAC.  
- **المدخلات:** مسارات المنتج (store/update/destroy)، نموذج User/Role/Permission الحالي، رسالة الخطأ الحالية.  
- **المطلوب:** راجع واصلح Authorization بحيث يُسمح بالعمليات لمن يملك الأذونات المناسبة، وأعد هيكلة Policy إن لزم. أضف اختبارات Feature تغطي السماح/المنع.  
- **قيود:** لا تغيّر عقود الـ API، واحفظ التوافق الخلفي، وأضف Audit Log عند الرفض.  
- **الخروج المتوقع:** Patch/PR Diff + اختبارات + توثيق صلاحيات محدث.

**Prompt لـ T-006 (حساب الخصم/الضريبة):**
- **الدور:** مطوّر Backend مالي.  
- **المدخلات:** دوال الحساب الحالية، صيغ الخصم (نسبة/قيمة)، ترتيب التطبيق، قواعد التقريب.  
- **المطلوب:** تنفيذ ترتيب حساب قياسي: Sum lines → Apply line discounts → Subtotal → Apply order-level discount → Compute tax → Grand total. غطِّ خصم يفوق Subtotal، والضرائب بعد/قبل الخصم حسب الإعداد.  
- **قيود:** اختبارات وحدات لحالات الحافة؛ عدم كسر التقارير.  
- **الخروج:** دوال محدثة + Unit tests + أمثلة رقمية.

**Prompt لـ T-007 (Transactional Save):**
- **الدور:** مطوّر Laravel.  
- **المطلوب:** لفّ إنشاء الفاتورة وبنودها والمدفوعات في Transaction واحدة، مع Rollback عند أي فشل، وسجّل سبب الفشل. أضف إعادة محاولة (مرّتين) للأعطال العابرة.  
- **الخروج:** PR + Feature tests مع محاكاة فشل.

**Prompt لـ T-010 (PDF Compatibility):**
- **الدور:** مختص توليد PDF.  
- **المدخلات:** تيمبلت الفواتير، مكتبة PDF الحالية.  
- **المطلوب:** جعل PDF متوافقًا مع Adobe/Chrome Readers، وفحصه بأداة validator، ومعالجة RTL/Arabic.  
- **الخروج:** PR + سكربت فحص + نموذج PDF صالح.

**Prompt لـ T-012 (Sequences 2025):**
- **الدور:** مطوّر قواعد بيانات.  
- **المطلوب:** Seeder يُنشئ/يحدّث sequences للسنوات الحالية تلقائيًا، مع fallback عند عدم توفّر مدخل السنة.  
- **الخروج:** Seeder + توثيق التشغيل + اختبار.

**Prompt لـ T-009 (اختيار العميل موحّد):**
- **الدور:** مطوّر Frontend.  
- **المطلوب:** إنشاء مكوّن Select للعميل يعتمد API موحّد مع بحث كسول وDebounce، وإحلاله بكل الوحدات.  
- **الخروج:** PR + Storybook + اختبارات UI.

---

## (9) لوحة تتبّع (Backlog)

| ID | النوع | العنوان | الحالة | الأولوية | المالك | تاريخ الاستحقاق | روابط/مرفقات |
|---|---|---|---|---|---|---|---|
| PROD-001 | Bug | Unauthorized بالمنتجات | To Do | P0 | Backend | **TBD** |  |
| SALE-003 | Bug | خصم لا ينعكس على الإجمالي | To Do | P1 | Backend | **TBD** | فيديو قادم |
| RET-001 | Bug | Sequence 2025 للمرتجعات | To Do | P1 | Backend | **TBD** |  |
| WH-001 | Bug | المخازن معطلة | To Do | P0 | Fullstack | **TBD** |  |
| IC-001 | Bug | الجرد معطل | To Do | P0 | Fullstack | **TBD** |  |
| RPT-001 | Bug | PDF غير قابل للفتح | To Do | P2 | Backend | **TBD** |  |
| PAY-001 | Bug | cheque_number نوع خاطئ | To Do | P1 | Backend | **TBD** |  |

---

## (10) خطة تحقق وإغلاق
- **معايير قبول شاملة:** تمرير كل قضايا P0/P1 وفق G/W/T؛ عدم انحدار في التقارير والحسابات.  
- **ريجريشن مختصر:** سيناريوهات إنشاء/تعديل/حذف منتج، إنشاء فاتورة مع خصم/ضريبة ومدفوعات، إنشاء مرتجع 2025، تصدير PDF/Excel، تشغيل المخازن والجرد.  
- **Post-release checks:** مراقبة أخطاء 4xx/5xx، زمن حفظ الفاتورة، عدد ملفات PDF الفاشلة، دقّة الإجمالي مقابل دفتر الأستاذ.  
- **Roll-back plan:** تعطيل الميزات الجديدة خلف Feature Flags عند ظهور عيوب حرجة وإعادة نشر النسخة السابقة.
